---
title: 作用域链和闭包
date: 2022/09/24
tags:
 - js
 - 闭包
categories:
 - js
--- 

1. 闭包例题

::: tip 闭包
+ 在计算机科学中对闭包的定义（维基百科）：
	- 闭包（英语：Closure），又称词法闭包（Lexical Closure）或函数闭包（function closures）；
	- 是在支持 头等函数 的编程语言中，实现词法绑定的一种技术；
	- `闭包在实现上是一个结构体，它存储了一个函数和一个关联的环境（相当于一个符号查找表）；`
	- 闭包跟函数最大的区别在于，当捕捉闭包的时候，它的 自由变量 会在捕捉时被确定，这样即使脱离了捕捉时的上下文，它也能照常运行；
+ MDN对JavaScript闭包的解释：
	- 一个函数和对其周围状态（lexical environment，词法环境）的引用捆绑在一起（或者说函数被引用包围），这样的组合就是闭包（closure）；
	- 也就是说，闭包让你可以在一个内层函数中访问到其外层函数的作用域；
	- 在 JavaScript 中，每当创建一个函数，闭包就会在函数创建的同时被创建出来；
+ 总结：
	- 一个普通的函数function，如果它可以访问外层作用于的自由变量，那么这个函数就是一个闭包；
	- 从广义的角度来说：JavaScript中的函数都是闭包；
	- 从狭义的角度来说：JavaScript中一个函数，如果访问了外层作用于的变量，那么它是一个闭包；
:::

```js
function foo() {
  var name = "foo"
  var age = 18

  function bar() {
    console.log(name)
    console.log(age)
  }
  return bar
}

var fn = foo()
fn()

fn = null
foo = null

// fn()
// fn()
// fn()
// fn()
// fn()
```
+ 在编译前会创建一个globalObject，将代码中的var变量属性值都写入(如图一中go，fn属性创建，初始化)
+ 在执行到该行代码就会赋值或者操作，如果提前打印或者使用，也不会报错
+ 如果是函数，就会在堆中创建一个存储空间指向对应的globalObject
+ 函数执行会创建一个函数执行上下文，也会有一个AO对象对应着拿到属性
+ 执行时再赋值

<div class='imp'>

+ 当函数执行完，函数执行上下文会被弹出栈，AO对象也会被销毁
+ 当再次执行函数时，函数执行上下文和AO对象会再次被创建 
+ **但是图二，bar是被go对象中的fn指向着，根据标记清除，在根元素能找到，bar不会销毁，那么foo的AO对象因为属于bar函数的parentScope的，自然也不会销毁**
+ 图三，当执行完bar函数的操作，那么bar函数的上下文和AO都会清除
+ 图四图五如果go中的fn重置为null，那么从根元素中找不到，虽然bar和foo的AO相互引用，仍然会被清除
+ 图六，当foo也置为null，那么虽然foo函数的parentscope指向go，但是go中找不到foo，根据标记清除，仍然会被清除


</div>



图一：<img src='/img/0002.png'/>

图二：<img src='/img/0001.png'/>

图三：<img src='/img/0003.png'/>

图四：<img src='/img/0004.png'/>

图五：<img src='/img/0005.png'/>

图六：<img src='/img/0006.png'/>

